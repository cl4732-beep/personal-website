---
import PageLayout from '../layouts/PageLayout.astro';
import { getBooks, groupBooksByMonth } from '../lib/notion';

let books: Awaited<ReturnType<typeof getBooks>> = [];
let error = false;

try {
  books = await getBooks();
} catch (e) {
  error = true;
  console.error('Notion API error:', e);
}

const finishedBooks = books.filter((b) => b.dateFinished && b.status !== 'Need to Buy');
const wishList = books.filter((b) => b.status === 'Need to Buy');
const byMonth = groupBooksByMonth(finishedBooks);

const totalRead = finishedBooks.length;
---

<PageLayout title="Books â€” Clemente Lacerda" description="Books I've read and my reading wish list">
  <section class="books-page">
    <h1>Books</h1>
    <p class="page-intro">
      <strong>{totalRead}</strong> books read and counting.
    </p>

    {error ? (
      <p class="error-state">Book data is temporarily unavailable. Check back soon.</p>
    ) : (
      <>
        {byMonth.length > 0 && (
          <div class="books-timeline">
            {byMonth.map((month) => (
              <section class="month-section">
                <h2 class="month-label label">{month.label}</h2>
                <ul class="book-list">
                  {month.books.map((book) => (
                    <li class="book-item">
                      <span class="book-name">{book.name}</span>
                      <span class="book-author">{book.author}</span>
                    </li>
                  ))}
                </ul>
              </section>
            ))}
          </div>
        )}

        {wishList.length > 0 && (
          <section class="wishlist-section">
            <hr />
            <h2 class="label">Wish List</h2>
            <ul class="book-list">
              {wishList.map((book) => (
                <li class="book-item">
                  <span class="book-name">{book.name}</span>
                  <span class="book-author">{book.author}</span>
                </li>
              ))}
            </ul>
          </section>
        )}
      </>
    )}
  </section>
</PageLayout>

<style>
  .books-page {
    padding-top: var(--space-3xl);
  }

  .books-page h1 {
    margin-bottom: var(--space-sm);
  }

  .page-intro {
    color: var(--color-text-muted);
    margin-bottom: var(--space-3xl);
  }

  .page-intro strong {
    color: var(--color-accent);
    font-weight: 600;
  }

  .books-timeline {
    display: flex;
    flex-direction: column;
    gap: var(--space-2xl);
  }

  .month-section h2 {
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-xs);
    border-bottom: 1px solid var(--color-border);
  }

  .book-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .book-item {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: var(--space-sm) 0;
    border-bottom: 1px solid var(--color-border);
    gap: var(--space-md);
    margin-bottom: 0;
    transition: color var(--transition-base);
  }

  .book-item:last-child {
    border-bottom: none;
  }

  .book-item:hover .book-name {
    color: var(--color-accent);
  }

  .book-name {
    font-weight: 500;
    color: var(--color-text);
    transition: color var(--transition-base);
  }

  .book-author {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    white-space: nowrap;
    flex-shrink: 0;
  }

  .wishlist-section {
    margin-top: var(--space-2xl);
  }

  .wishlist-section h2 {
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-xs);
    border-bottom: 1px solid var(--color-border);
  }

  .wishlist-section .book-name {
    font-style: italic;
  }

  .error-state {
    color: var(--color-text-muted);
    font-style: italic;
  }

  @media (min-width: 640px) {
    .books-page {
      padding-top: var(--space-4xl);
    }
  }
</style>
