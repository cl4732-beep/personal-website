---
import PageLayout from '../layouts/PageLayout.astro';
import { getBooks, groupBooksByYear } from '../lib/notion';

let books: Awaited<ReturnType<typeof getBooks>> = [];
let error = false;

try {
  books = await getBooks();
} catch (e) {
  error = true;
  console.error('Notion API error:', e);
}

const byYear = groupBooksByYear(books);
const years = byYear.map((g) => g.year);
const defaultYear = years[0] ?? new Date().getFullYear().toString();
---

<PageLayout title="Books — Clemente Lacerda" description="Books I've read, organized by year">
  <section class="books-page">
    <h1>Books</h1>
    <div class="page-quotes">
      <blockquote>
        "It is what you read when you don't have to that determines what you will be when you can't help it."
        <cite>Oscar Wilde</cite>
      </blockquote>
      <blockquote>
        "Fairy tales are more than true: not because they tell us that dragons exist, but because they tell us that dragons can be beaten."
        <cite>Neil Gaiman</cite>
      </blockquote>
    </div>

    {error ? (
      <p class="error-state">Book data is temporarily unavailable. Check back soon.</p>
    ) : (
      <>
        <div class="year-toggles" role="tablist" aria-label="Filter books by year">
          {years.map((year) => (
            <button
              class:list={['year-btn', { active: year === defaultYear }]}
              role="tab"
              aria-selected={year === defaultYear ? 'true' : 'false'}
              data-year={year}
            >
              {year}
            </button>
          ))}
        </div>

        <div class="year-sections">
          {byYear.map((group) => (
            <section
              class="year-section"
              data-year-section={group.year}
              style={group.year !== defaultYear ? 'display: none;' : ''}
              role="tabpanel"
            >
              {group.reading.length > 0 && (
                <div class="book-group">
                  <h2 class="label">Currently Reading</h2>
                  <ul class="book-grid">
                    {group.reading.map((book) => (
                      <li class="book-card">
                        <span class="book-title">{book.name}</span>
                        <span class="book-author">{book.author}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              )}

              {group.read.length > 0 && (
                <div class="book-group">
                  <h2 class="label">Read</h2>
                  <ul class="book-grid">
                    {group.read.map((book) => (
                      <li class="book-card">
                        <span class="book-title">{book.name}</span>
                        <span class="book-author">{book.author}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              )}

              {group.read.length === 0 && group.reading.length === 0 && (
                <p class="empty-state">No books for this year yet.</p>
              )}
            </section>
          ))}
        </div>
      </>
    )}
  </section>
</PageLayout>

<script>
  function initBookToggles() {
    const buttons = document.querySelectorAll<HTMLButtonElement>('.year-btn');
    const sections = document.querySelectorAll<HTMLElement>('[data-year-section]');

    buttons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const year = btn.dataset.year;

        // Update buttons
        buttons.forEach((b) => {
          b.classList.remove('active');
          b.setAttribute('aria-selected', 'false');
        });
        btn.classList.add('active');
        btn.setAttribute('aria-selected', 'true');

        // Update sections
        sections.forEach((section) => {
          section.style.display = section.dataset.yearSection === year ? '' : 'none';
        });
      });
    });
  }

  initBookToggles();
  document.addEventListener('astro:after-swap', initBookToggles);
</script>

<style>
  .books-page {
    padding-top: var(--space-3xl);
  }

  .books-page h1 {
    margin-bottom: var(--space-lg);
  }

  .page-quotes {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    margin-bottom: var(--space-3xl);
    max-width: var(--content-max-width);
  }

  .page-quotes blockquote {
    border-left: none;
    padding-left: 0;
    margin: 0;
    font-style: italic;
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    line-height: var(--leading-body);
  }

  .page-quotes cite {
    font-style: normal;
    color: var(--color-accent);
    font-size: var(--text-xs);
    letter-spacing: var(--tracking-wide);
  }

  .page-quotes cite::before {
    content: '— ';
  }

  /* --- Year toggle buttons --- */
  .year-toggles {
    display: flex;
    gap: var(--space-md);
    margin-bottom: var(--space-3xl);
  }

  .year-btn {
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    padding: var(--space-xs) var(--space-lg);
    border: 1px solid var(--color-border);
    border-radius: 100px;
    background-color: transparent;
    color: var(--color-text-muted);
    cursor: pointer;
    transition:
      background-color var(--transition-base),
      color var(--transition-base),
      border-color var(--transition-base);
  }

  .year-btn:hover {
    color: var(--color-text);
    border-color: var(--color-text-muted);
  }

  .year-btn.active {
    background-color: var(--color-accent);
    color: var(--color-bg);
    border-color: var(--color-accent);
  }

  .year-btn:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  /* --- Year sections --- */
  .year-sections {
    display: flex;
    flex-direction: column;
  }

  .year-section {
    display: flex;
    flex-direction: column;
    gap: var(--space-2xl);
  }

  .book-group h2 {
    margin-bottom: var(--space-lg);
  }

  /* --- Book grid --- */
  .book-grid {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-md);
  }

  .book-card {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
    padding: var(--space-md) 0;
    border-bottom: 1px solid var(--color-border);
    transition: color var(--transition-base);
  }

  .book-card:last-child {
    border-bottom: none;
  }

  .book-card:hover .book-title {
    color: var(--color-accent);
  }

  .book-title {
    font-weight: 500;
    color: var(--color-text);
    transition: color var(--transition-base);
    line-height: var(--leading-snug);
  }

  .book-author {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
  }

  .empty-state {
    color: var(--color-text-muted);
    font-style: italic;
  }

  .error-state {
    color: var(--color-text-muted);
    font-style: italic;
  }

  /* --- Responsive grid --- */
  @media (min-width: 480px) {
    .book-grid {
      grid-template-columns: repeat(2, 1fr);
      column-gap: var(--space-2xl);
    }
  }

  @media (min-width: 640px) {
    .books-page {
      padding-top: var(--space-4xl);
    }
  }

  @media (min-width: 900px) {
    .book-grid {
      grid-template-columns: repeat(3, 1fr);
      column-gap: var(--space-3xl);
    }
  }
</style>
