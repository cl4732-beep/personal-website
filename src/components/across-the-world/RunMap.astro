---
interface Run {
  lat: number;
  lng: number;
  name: string;
  date: string;
  distance: number;
  moving_time: number;
  media: string[];
  gear: string;
}

interface Route {
  name: string;
  coordinates: [number, number][];
}

interface Props {
  runs: Run[];
  routes: Route[];
}

const { runs, routes } = Astro.props;
---

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<div class="map-wrapper">
  <div id="run-map"></div>
</div>

<script id="map-data" type="application/json" set:html={JSON.stringify({ runs, routes })} />

<script>
  import L from 'leaflet';
  import 'leaflet.markercluster';

  function formatDistance(meters: number): string {
    const km = meters / 1000;
    return km >= 10 ? `${km.toFixed(0)} km` : `${km.toFixed(1)} km`;
  }

  function formatDuration(seconds: number): string {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    if (h > 0) return `${h}h ${m.toString().padStart(2, '0')}m`;
    return `${m}m`;
  }

  function formatPace(distance: number, movingTime: number): string {
    if (distance === 0 || movingTime === 0) return '—';
    const metersPerSecond = distance / movingTime;
    const minPerKm = 1000 / metersPerSecond / 60;
    const mins = Math.floor(minPerKm);
    const secs = Math.round((minPerKm - mins) * 60);
    return `${mins}:${secs.toString().padStart(2, '0')} /km`;
  }

  function escapeHtml(str: string): string {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  interface RunData {
    lat: number;
    lng: number;
    name: string;
    date: string;
    distance: number;
    moving_time: number;
    media: string[];
    gear: string;
  }

  interface RouteData {
    name: string;
    coordinates: [number, number][];
  }

  function initMap() {
    const dataEl = document.getElementById('map-data');
    if (!dataEl) return;

    const { runs, routes }: { runs: RunData[]; routes: RouteData[] } = JSON.parse(
      dataEl.textContent || '{"runs":[],"routes":[]}'
    );

    if (runs.length === 0) return;

    const mapEl = document.getElementById('run-map');
    if (!mapEl) return;

    // Prevent re-initialization after View Transitions
    if ((mapEl as any)._leaflet_id) return;

    const map = L.map(mapEl, {
      scrollWheelZoom: false,
      zoomControl: true,
    });

    // CartoDB Positron — clean, muted tiles
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19,
    }).addTo(map);

    // ── Route Polylines ──────────────────────────────────────────────
    const routeLayers: L.Polyline[] = [];

    routes.forEach((route) => {
      if (route.coordinates.length < 2) return;

      const polyline = L.polyline(route.coordinates as L.LatLngExpression[], {
        color: '#2D5F3F',
        weight: 2.5,
        opacity: 0.5,
        smoothFactor: 1,
      }).addTo(map);

      polyline.bindPopup(
        `<div class="route-popup">
          <strong class="route-popup-name">${escapeHtml(route.name)}</strong>
          <span class="route-popup-type">Saved Route</span>
        </div>`,
        { className: 'route-popup-container' }
      );

      // Highlight on hover
      polyline.on('mouseover', () => {
        polyline.setStyle({ opacity: 0.9, weight: 4 });
      });
      polyline.on('mouseout', () => {
        polyline.setStyle({ opacity: 0.5, weight: 2.5 });
      });

      routeLayers.push(polyline);
    });

    // ── Run Markers with Clustering ──────────────────────────────────

    // Custom pin icon
    const pinIcon = L.divIcon({
      className: 'run-pin',
      html: `<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="6" cy="6" r="5" fill="#2D5F3F" stroke="#F8F7F4" stroke-width="2"/>
      </svg>`,
      iconSize: [12, 12],
      iconAnchor: [6, 6],
      popupAnchor: [0, -8],
    });

    // Pin with photo indicator
    const photoPinIcon = L.divIcon({
      className: 'run-pin',
      html: `<svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="7" cy="7" r="6" fill="#2D5F3F" stroke="#F8F7F4" stroke-width="2"/>
        <circle cx="7" cy="7" r="2" fill="#F8F7F4"/>
      </svg>`,
      iconSize: [14, 14],
      iconAnchor: [7, 7],
      popupAnchor: [0, -9],
    });

    const clusterGroup = (L as any).markerClusterGroup({
      maxClusterRadius: 40,
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      iconCreateFunction: function (cluster: any) {
        const count = cluster.getChildCount();
        let size = 'small';
        if (count >= 50) size = 'large';
        else if (count >= 10) size = 'medium';

        return L.divIcon({
          html: `<span>${count}</span>`,
          className: `run-cluster run-cluster-${size}`,
          iconSize: L.point(36, 36),
        });
      },
    });

    runs.forEach((run) => {
      const date = new Date(run.date).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
      });

      // Build photo HTML if media exists
      let photoHtml = '';
      if (run.media && run.media.length > 0) {
        const images = run.media
          .filter((m) => m.endsWith('.jpg') || m.endsWith('.jpeg') || m.endsWith('.png'))
          .slice(0, 3);
        if (images.length > 0) {
          photoHtml = `<div class="run-popup-photos">${images
            .map(
              (img) =>
                `<img src="/${img}" alt="${escapeHtml(run.name)}" loading="lazy" class="run-popup-photo" />`
            )
            .join('')}</div>`;
        }
      }

      // Build gear tag
      const gearHtml =
        run.gear && run.gear.length > 0
          ? `<span class="run-popup-gear">${escapeHtml(run.gear)}</span>`
          : '';

      const popup = `
        <div class="run-popup">
          ${photoHtml}
          <strong class="run-popup-name">${escapeHtml(run.name)}</strong>
          <span class="run-popup-date">${date}</span>
          <div class="run-popup-stats">
            <span>${formatDistance(run.distance)}</span>
            <span class="run-popup-sep">&middot;</span>
            <span>${formatDuration(run.moving_time)}</span>
            <span class="run-popup-sep">&middot;</span>
            <span>${formatPace(run.distance, run.moving_time)}</span>
          </div>
          ${gearHtml}
        </div>
      `;

      const hasPhotos = run.media && run.media.length > 0;
      const icon = hasPhotos ? photoPinIcon : pinIcon;
      const marker = L.marker([run.lat, run.lng], { icon }).bindPopup(popup, {
        maxWidth: 280,
        minWidth: 180,
      });

      clusterGroup.addLayer(marker);
    });

    map.addLayer(clusterGroup);

    // ── Fit Bounds ───────────────────────────────────────────────────
    const allBounds = L.latLngBounds([]);

    const markerBounds = clusterGroup.getBounds();
    if (markerBounds.isValid()) {
      allBounds.extend(markerBounds);
    }

    routeLayers.forEach((rl) => {
      const rb = rl.getBounds();
      if (rb.isValid()) {
        allBounds.extend(rb);
      }
    });

    if (allBounds.isValid()) {
      map.fitBounds(allBounds, { padding: [40, 40], maxZoom: 12 });
    }

    // Enable scroll zoom on first click
    map.on('click', () => {
      map.scrollWheelZoom.enable();
    });
  }

  // Initialize on page load and after View Transitions
  document.addEventListener('astro:page-load', initMap);
</script>

<style>
  .map-wrapper {
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--color-border);
    background-color: var(--color-surface);
  }

  #run-map {
    width: 100%;
    height: 420px;
  }

  @media (min-width: 640px) {
    #run-map {
      height: 520px;
    }
  }

  @media (min-width: 1100px) {
    #run-map {
      height: 600px;
    }
  }

  /* Custom pin marker */
  :global(.run-pin) {
    background: transparent !important;
    border: none !important;
  }

  /* Cluster styles */
  :global(.run-cluster) {
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    font-family: var(--font-mono);
    font-size: 12px;
    font-weight: 600;
    color: #F8F7F4;
    background-color: #2D5F3F;
    border: 2px solid #F8F7F4;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
  }

  :global(.run-cluster-small) {
    width: 32px;
    height: 32px;
    font-size: 11px;
  }

  :global(.run-cluster-medium) {
    width: 40px;
    height: 40px;
    font-size: 12px;
  }

  :global(.run-cluster-large) {
    width: 48px;
    height: 48px;
    font-size: 13px;
  }

  /* Popup styles */
  :global(.run-popup) {
    font-family: "Iowan Old Style", "Apple Garamond", "Baskerville",
      "Times New Roman", serif;
    line-height: 1.5;
  }

  :global(.run-popup-name) {
    display: block;
    font-size: 14px;
    color: #1A1A1A;
    margin-bottom: 2px;
  }

  :global(.run-popup-date) {
    display: block;
    font-size: 12px;
    color: #6B7280;
    margin-bottom: 6px;
  }

  :global(.run-popup-stats) {
    font-size: 12px;
    color: #2D5F3F;
    font-weight: 500;
  }

  :global(.run-popup-sep) {
    margin: 0 4px;
    color: #D1CFC7;
  }

  :global(.run-popup-gear) {
    display: inline-block;
    margin-top: 6px;
    font-size: 11px;
    color: #6B7280;
    background: #F0EFEB;
    padding: 1px 8px;
    border-radius: 10px;
  }

  /* Photo popup styles */
  :global(.run-popup-photos) {
    display: flex;
    gap: 4px;
    margin-bottom: 8px;
    overflow: hidden;
    border-radius: 4px;
  }

  :global(.run-popup-photo) {
    width: 100%;
    max-height: 160px;
    object-fit: cover;
    border-radius: 4px;
    display: block;
  }

  :global(.run-popup-photos .run-popup-photo:not(:first-child)) {
    display: none;
  }

  @media (min-width: 640px) {
    :global(.run-popup-photos .run-popup-photo:not(:first-child)) {
      display: block;
    }

    :global(.run-popup-photo) {
      width: 50%;
      max-height: 120px;
    }
  }

  /* Route popup styles */
  :global(.route-popup-name) {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #1A1A1A;
    font-family: "Iowan Old Style", "Apple Garamond", "Baskerville",
      "Times New Roman", serif;
  }

  :global(.route-popup-type) {
    display: block;
    font-size: 11px;
    color: #2D5F3F;
    font-weight: 500;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    margin-top: 2px;
  }

  /* Override Leaflet popup styles */
  :global(.leaflet-popup-content-wrapper) {
    border-radius: 6px !important;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1) !important;
    padding: 0 !important;
  }

  :global(.leaflet-popup-content) {
    margin: 10px 14px !important;
    font-size: 13px !important;
  }

  :global(.leaflet-popup-tip) {
    box-shadow: none !important;
  }

  /* Override default MarkerCluster styles */
  :global(.marker-cluster-small),
  :global(.marker-cluster-medium),
  :global(.marker-cluster-large) {
    background-color: transparent !important;
  }

  :global(.marker-cluster-small div),
  :global(.marker-cluster-medium div),
  :global(.marker-cluster-large div) {
    background-color: transparent !important;
  }
</style>
