---
import type { StravaActivity } from '../../lib/strava';

interface Props {
  activities: StravaActivity[];
}

const { activities } = Astro.props;

// Group activities by week for the bar chart
const weeklyMap = new Map<string, number>();
for (const activity of activities) {
  const date = new Date(activity.start_date_local);
  // Get the Monday of the week
  const day = date.getDay();
  const monday = new Date(date);
  monday.setDate(date.getDate() - ((day + 6) % 7));
  const weekKey = monday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  weeklyMap.set(weekKey, (weeklyMap.get(weekKey) || 0) + activity.distance / 1000);
}

// Convert to arrays (reversed so oldest is first)
const weeklyLabels = Array.from(weeklyMap.keys()).reverse();
const weeklyValues = Array.from(weeklyMap.values()).reverse();

// Count activity types for the doughnut
const typeMap = new Map<string, number>();
for (const activity of activities) {
  typeMap.set(activity.type, (typeMap.get(activity.type) || 0) + 1);
}
const typeLabels = Array.from(typeMap.keys());
const typeValues = Array.from(typeMap.values());

const weeklyData = JSON.stringify({ labels: weeklyLabels, values: weeklyValues });
const typeData = JSON.stringify({ labels: typeLabels, values: typeValues });
---

<div class="activity-charts">
  <div class="chart-section">
    <h3 class="label">Weekly distance (km)</h3>
    <div class="chart-container">
      <canvas id="weekly-chart" data-chart={weeklyData}></canvas>
    </div>
  </div>
  <div class="chart-section chart-section-small">
    <h3 class="label">Activity breakdown</h3>
    <div class="chart-container chart-container-small">
      <canvas id="type-chart" data-chart={typeData}></canvas>
    </div>
  </div>
</div>

<script>
  import Chart from 'chart.js/auto';

  function initCharts() {
    const style = getComputedStyle(document.documentElement);
    const textColor = style.getPropertyValue('--color-text-muted').trim();
    const accentColor = style.getPropertyValue('--color-accent').trim();
    const borderColor = style.getPropertyValue('--color-border').trim();
    const surfaceColor = style.getPropertyValue('--color-surface').trim();

    Chart.defaults.color = textColor;
    Chart.defaults.borderColor = borderColor;
    Chart.defaults.font.family =
      '"Berkeley Mono", "JetBrains Mono", "Menlo", "Consolas", monospace';
    Chart.defaults.font.size = 11;

    // Weekly distance bar chart
    const weeklyCanvas = document.getElementById('weekly-chart') as HTMLCanvasElement;
    if (weeklyCanvas) {
      const data = JSON.parse(weeklyCanvas.dataset.chart!);
      new Chart(weeklyCanvas, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [
            {
              data: data.values.map((v: number) => Math.round(v * 10) / 10),
              backgroundColor: accentColor,
              borderRadius: 3,
              barPercentage: 0.7,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              grid: { color: borderColor },
              ticks: { callback: (v) => `${v}` },
            },
            x: { grid: { display: false } },
          },
        },
      });
    }

    // Activity type doughnut chart
    const typeCanvas = document.getElementById('type-chart') as HTMLCanvasElement;
    if (typeCanvas) {
      const data = JSON.parse(typeCanvas.dataset.chart!);
      // Green palette variations for doughnut segments
      const colors = [accentColor, '#1B4332', '#6EBF8B', '#A3D9B5', surfaceColor, borderColor];
      new Chart(typeCanvas, {
        type: 'doughnut',
        data: {
          labels: data.labels,
          datasets: [
            {
              data: data.values,
              backgroundColor: colors.slice(0, data.labels.length),
              borderWidth: 0,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { padding: 16 } },
          },
        },
      });
    }
  }

  initCharts();
  document.addEventListener('astro:after-swap', initCharts);
</script>

<style>
  .activity-charts {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-2xl);
  }

  .chart-section h3 {
    margin-bottom: var(--space-md);
  }

  .chart-container {
    height: 220px;
    position: relative;
  }

  .chart-container-small {
    height: 300px;
    max-width: 360px;
  }

  @media (min-width: 640px) {
    .activity-charts {
      grid-template-columns: 1fr 1fr;
    }
  }
</style>
